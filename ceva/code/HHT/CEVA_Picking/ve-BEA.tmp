Imports System.Data

Public Class frm_cartonQery

    '实例化一个委托对象，指向本窗口自己的处理函数ff
    Private thisFrom_del_CheckBarcode As del_CheckBarcode = New del_CheckBarcode(AddressOf CheckBarcode)
    ' 检验读取到的条码
    Private Sub CheckBarcode(ByVal barcode As String)
        Dim ls_barcode As String = ""
        ls_barcode = barcode.Trim
        If ls_barcode.IndexOf("%") >= 0 Then
            ls_barcode = Mid(ls_barcode, 2) '不取得百分号
        End If

        TextBox_cartonbarcode.Text = ls_barcode
        TextBox_cartonbarcode.Focus()
        TextBox_cartonbarcode.SelectAll()
        queryData1()
    End Sub
   
    Private Sub Fm_Closing(ByVal sender As System.Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles MyBase.Closing
        '取消扫描驱动
        gf_del_CheckBarcode = [Delegate].Remove(gf_del_CheckBarcode, thisFrom_del_CheckBarcode)
    End Sub

    Private Sub frm_cartonQery_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        gf_del_CheckBarcode = [Delegate].Combine(gf_del_CheckBarcode, thisFrom_del_CheckBarcode)
        Me.TextBox_cartonbarcode.Focus()
        TextBox_cartonbarcode.SelectAll()
    End Sub

    Private Sub btn_ok_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btn_ok.Click
        queryData2()
    End Sub

    Private Sub cb_stage_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cb_stage.SelectedIndexChanged
        queryData2()
    End Sub

    Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click
        Me.Close()
    End Sub

    Private Sub TextBox_cartonbarcode_KeyDown(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles TextBox_cartonbarcode.KeyDown
        If e.KeyCode = Keys.Enter Then
            queryData1()
        End If
    End Sub

    ''' <summary>
    ''' 按照托盘号查询业务阶段
    ''' </summary>
    ''' <remarks></remarks>
    Private Sub queryData1()
        Dim cartonbarcode As String = Me.TextBox_cartonbarcode.Text.Trim
        Try
            ListView1.Items.Clear()
            cb_stage.Items.Clear()
            Cursor.Current = Cursors.WaitCursor
            If cartonbarcode = "" Then
                alert("请输入或者扫描箱条码!")
                Return
            End If
            '@tray,@sErr
            Dim ds As DataSet = M_Service1.RunProcedure_DS("sp_HHTQuery_CartonStage", "@cartonbarcode|varchar|" + cartonbarcode + "|inpurt;@sErr|varchar||output")
            If IsNothing(ds.Tables(0).Rows(0)(0)) Then
                Return
            End If
            If IsDBNull(ds.Tables(0).Rows(0)(0)) Then
                Return
            End If
            Dim sErr As String = ds.Tables(0).Rows(0)(0).ToString()
            If sErr <> "" Then
                alert(sErr)
                Return
            End If
            Dim info As String = ""
            If ds.Tables.Count > 1 Then
                If ds.Tables(1).Rows.Count > 0 Then
                    info = ds.Tables(1).Rows(0)(0).ToString()
                    Dim data() As String = info.Split("|")
                    For index As Integer = 0 To data.Length - 1
                        If data(index).Trim <> "|" And data(index).Trim <> "" Then
                            Dim info2 As String = data(index).Trim
                            If info2 = "ST1" Then
                                info2 = "ST1" + "-收货"
                            End If
                            If info2 = "ST2" Then
                                info2 = "ST2" + "-清点"
                            End If
                            If info2 = "ST3" Then
                                info2 = "ST3" + "-大类分播"
                            End If
                            If info2 = "ST4" Then
                                info2 = "ST4" + "-二次操作"
                            End If
                            Me.cb_stage.Items.Add(data(index).Trim)
                        End If
                    Next

                    If cb_stage.Items.Count > 0 Then
                        cb_stage.SelectedIndex = 0 '选定第一个
                        queryData2() '自动查询数据
                    End If

                End If
            End If
        Catch ex As Exception
            alert(ex.Message)
        Finally
            Cursor.Current = Cursors.Default
        End Try
    End Sub

    ''' <summary>
    ''' 按照托盘号和业务阶段,查询具体的数据
    ''' </summary>
    ''' <remarks></remarks>
    Private Sub queryData2()
        Dim cartonbarcodebarcode As String = Me.TextBox_cartonbarcode.Text.Trim
        If cartonbarcodebarcode = "" Then
            alert("请输入或者扫描托盘条码!")
            Return
        End If
        Dim stage As String = ""
        Try
            ListView1.Items.Clear()
            Cursor.Current = Cursors.WaitCursor
            
            If IsNothing(cb_stage.SelectedItem) Then
                alert("请选择业务阶段!")
                Return
            End If

            stage = cb_stage.SelectedItem.ToString()
            stage = Mid(stage, 1, 3) '取得前三个字符

            'sp_HHTQuery_TrayData @tray,@stage,@sErr
            Dim ds As DataSet = M_Service1.RunProcedure_DS("sp_HHTQuery_CartonData", "@cartonbarcode|varchar|" + cartonbarcodebarcode + "|inpurt;@stage|varchar|" + stage + "|inpurt;@sErr|varchar||output")
            If IsNothing(ds.Tables(0).Rows(0)(0)) Then
                Return
            End If
            If IsDBNull(ds.Tables(0).Rows(0)(0)) Then
                Return
            End If
            Dim sErr As String = ds.Tables(0).Rows(0)(0).ToString()
            If sErr <> "" Then
                alert(sErr)
                Return
            End If

            If ds.Tables.Count > 1 Then
                showData(stage, ds.Tables(1))
            End If
            
        Catch ex As Exception
            alert(ex.Message)
        Finally
            Cursor.Current = Cursors.Default
        End Try

    End Sub

    Private Sub showData(ByVal as_stage As String, ByRef adt_dt As DataTable)
        'ST1'	-- 收货,返回        ==> boxState,SKU,qty,tray1,location1,weightBox,weightReal
        'ST2'	-- 清点,返回        ==> boxState,SKU,skustate,cartonbarcode1,qty, Aqty, Dqty, Bqty, tray1, location1
        'ST3'	-- 大类分播查询     ==> boxState,SKU, bcno, mqty, rqty,bclocation
        'ST4'	-- 二次分拣/分播    ==> boxState,SKU, packqty, rqty, newtray,location
        Me.ll_cnt.Text = ""
        Dim sumQty As Integer = 0
        Dim boxState, SKU, qty, tray1, location1, weightBox, weightReal As String
        If as_stage = "ST1" Then
            sumQty = 0
            ListView1.Items.Clear()
            If adt_dt.Rows.Count > 0 Then
                For index As Integer = 0 To adt_dt.Rows.Count - 1
                    boxState = adt_dt.Rows(index)("boxState").ToString()
                    SKU = adt_dt.Rows(index)("SKU").ToString()
                    qty = adt_dt.Rows(index)("qty").ToString()
                    sumQty = sumQty + CType(qty, Integer)
                    tray1 = adt_dt.Rows(index)("tray1").ToString()
                    location1 = adt_dt.Rows(index)("location1").ToString()
                    weightBox = adt_dt.Rows(index)("weightBox").ToString()
                    weightReal = adt_dt.Rows(index)("weightReal").ToString()

                    Dim new_no As Integer = ListView1.Items.Count + 1
                    Dim new_item As ListViewItem = New ListViewItem
                    new_item.Text = new_no.ToString()
                    new_item.SubItems.Add(boxState)
                    new_item.SubItems.Add(SKU)
                    new_item.SubItems.Add(qty)
                    new_item.SubItems.Add(tray1)
                    new_item.SubItems.Add(location1)
                    new_item.SubItems.Add(weightBox)
                    new_item.SubItems.Add(weightReal)
                    ListView1.Items.Add(new_item)
                Next
                ListView1.Refresh()
            End If
            Me.ll_cnt.Text = ListView1.Items.Count.ToString()
            Me.Panel1.Visible = True
            Panel1.Location = New Point(3, 85)
            Panel1.BringToFront()
        End If

        'boxState, SKU, skustate, cartonbarcode1, qty, Aqty, Dqty, Bqty, tray1, location1
        Dim skustate, cartonbarcode1, Aqty, Dqty, Bqty As String
        If as_stage = "ST2" Then
            ListView2.Items.Clear()
            If adt_dt.Rows.Count > 0 Then
                For index As Integer = 0 To adt_dt.Rows.Count - 1
                    boxState = adt_dt.Rows(index)("boxState").ToString()
                    SKU = adt_dt.Rows(index)("SKU").ToString()
                    skustate = adt_dt.Rows(index)("skustate").ToString()
                    cartonbarcode1 = adt_dt.Rows(index)("cartonbarcode1").ToString()
                    qty = adt_dt.Rows(index)("qty").ToString()
                    Aqty = adt_dt.Rows(index)("Aqty").ToString()
                    Bqty = adt_dt.Rows(index)("Bqty").ToString()
                    Dqty = adt_dt.Rows(index)("Dqty").ToString()
                    tray1 = adt_dt.Rows(index)("tray1").ToString()
                    location1 = adt_dt.Rows(index)("location1").ToString()
                    Aqty = Aqty.Trim + "," + Bqty.Trim + "," + Dqty.Trim

                    Dim new_no As Integer = ListView2.Items.Count + 1
                    Dim new_item As ListViewItem = New ListViewItem
                    new_item.Text = new_no.ToString()
                    new_item.SubItems.Add(boxState)
                    new_item.SubItems.Add(SKU)
                    new_item.SubItems.Add(skustate)
                    new_item.SubItems.Add(cartonbarcode1)
                    new_item.SubItems.Add(qty)
                    new_item.SubItems.Add(Aqty)
                    new_item.SubItems.Add(tray1)
                    new_item.SubItems.Add(location1)
                    ListView2.Items.Add(new_item)
                Next
                ListView2.Refresh()
            End If
            Me.ll_cnt.Text = ListView2.Items.Count.ToString()
            Me.Panel2.Visible = True
            Panel2.Location = New Point(3, 85)
            Panel2.BringToFront()
        End If

        'boxState,SKU, bcno, mqty, rqty,bclocation
        Dim bcno, mqty, rqty, bclocation As String
        If as_stage = "ST3" Then
            ListView3.Items.Clear()
            If adt_dt.Rows.Count > 0 Then
                For index As Integer = 0 To adt_dt.Rows.Count - 1
                    boxState = adt_dt.Rows(index)("boxState").ToString()
                    SKU = adt_dt.Rows(index)("SKU").ToString()
                    bcno = adt_dt.Rows(index)("bcno").ToString()
                    mqty = adt_dt.Rows(index)("mqty").ToString()
                    rqty = adt_dt.Rows(index)("rqty").ToString()
                    bclocation = adt_dt.Rows(index)("bclocation").ToString()
                    Dim new_no As Integer = ListView3.Items.Count + 1
                    Dim new_item As ListViewItem = New ListViewItem
                    new_item.Text = new_no.ToString()
                    new_item.SubItems.Add(boxState)
                    new_item.SubItems.Add(SKU)
                    new_item.SubItems.Add(bcno)
                    new_item.SubItems.Add(mqty)
                    new_item.SubItems.Add(rqty)
                    new_item.SubItems.Add(bclocation)
                    ListView3.Items.Add(new_item)
                Next
                ListView3.Refresh()
            End If
            Me.ll_cnt.Text = ListView3.Items.Count.ToString()
            Me.Panel3.Visible = True
            Panel3.Location = New Point(3, 85)
            Panel3.BringToFront()
        End If

        'boxState,SKU, packqty, rqty, newtray,location
        Dim packqty, newtray, location As String
        If as_stage = "ST4" Then
            ListView4.Items.Clear()
            If adt_dt.Rows.Count > 0 Then
                For index As Integer = 0 To adt_dt.Rows.Count - 1
                    boxState = adt_dt.Rows(index)("boxState").ToString()
                    SKU = adt_dt.Rows(index)("SKU").ToString()
                    packqty = adt_dt.Rows(index)("packqty").ToString()
                    rqty = adt_dt.Rows(index)("rqty").ToString()
                    newtray = adt_dt.Rows(index)("newtray").ToString()
                    location = adt_dt.Rows(index)("location").ToString()
                    Dim new_no As Integer = ListView4.Items.Count + 1
                    Dim new_item As ListViewItem = New ListViewItem
                    new_item.Text = new_no.ToString()
                    new_item.SubItems.Add(boxState)
                    new_item.SubItems.Add(SKU)
                    new_item.SubItems.Add(packqty)
                    new_item.SubItems.Add(rqty)
                    new_item.SubItems.Add(newtray)
                    new_item.SubItems.Add(location)
                    ListView4.Items.Add(new_item)
                Next
                ListView4.Refresh()
            End If
            Me.ll_cnt.Text = ListView4.Items.Count.ToString()
            Me.Panel4.Visible = True
            Panel4.Location = New Point(3, 85)
            Panel4.BringToFront()
        End If

    End Sub

End Class